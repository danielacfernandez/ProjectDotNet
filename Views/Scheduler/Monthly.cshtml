@model ServiceTRAX.Models.ViewModels.MonthlySchedulerModel
@using ServiceTRAX.Utils


@{
    ViewData["Title"] = "Monthly Scheduler | ServiceTRAX - Powered by Omni Workspace Company";
}


<style type="text/css">

    .day-green {
        background-color: #008d00
    }

    .day-yellow {
        background-color: #b9b900
    }

    .day-orange {
        background-color: orange
    }

    .day-red {
        background-color: #e10000
    }

    .number-green {
        color: #008d00
    }

    .number-yellow {
        color: #b9b900
    }

    .number-orange {
        color: orange
    }

    .number-red {
        color: #e10000
    }

    .highlight-curr-day {
        border: #0f65ff solid 5px;
        background-color: white;
    }

    #color-legend-table td {
        padding: 0px 1rem;
    }

    #color-legend-table th {
        padding: 0px 1rem;
    }

    .text-black {
        color: black;
    }

    .legend-box {
        background-color: rgb(237 240 245 / 0.92);
        border-radius: 15px;
    }
</style>

@section StyleSheets {
    <link rel="stylesheet" href="~/css/datepicker.css" />
    <link rel="stylesheet" href="~/css/calendar.css" />
}

    @section Scripts {
    <script type='text/javascript' src='~/lib/knockout/knockout-latest.js'></script>
    <script type='text/javascript' src='~/lib/moment/moment.min.js'></script>
    <script type='text/javascript' src='~/lib/datepicker.js'></script>
    <script type='text/javascript' src='~/js/ko-bindingHandlers.js'></script>
    <script type='text/javascript' src='~/override/main-custom.js'></script>

    <script type="text/javascript">

        $(function() {
            // Get the MVC model as JS
            var model = @Html.Raw(JSONUtils.JsonUTC(Model));
            console.log('model', model);

            function scrollToDivElem(div) {
                $('html,body').animate({ scrollTop: calcTop(div) }, 'slow');
            }

            model.date = model.date ? ko.observable(model.date) : ko.observable(moment(new Date()).startOf('day').toJSON());
            model.date.subscribe(() => model.reloadMonthlyScheduler());
            model.resourceLocationId = ko.observable(model.resourceLocationId);
            model.resourceLocationId.subscribe(function() {
                // Save Monthly Scheduler Settings and reload the page
                postWrapper('/api/v1/usermonthlyschedulesettings', ko.toJSON({ OrganizationID: model.organizationID, SelectedLocation: model.resourceLocationId() }))
                    .then((r) => model.reloadMonthlyScheduler());
            });

            model.reloadMonthlyScheduler = function() {
                redirectToPage('/Scheduler/Monthly', {
                    'OrganizationID': model.organizationID,
                    'Date': moment(model.date()).startOf('month').toISOString()
                });
            };
            //

            model.redirectToDay = function (day) {
                return '/Scheduler/Daily?OrganizationID=' + model.organizationID + '&Date=' + moment(day).toISOString();
                };

            model.goToPrevMonth = () => {
                model.date(moment(model.date()).add(-1, 'M'));
            }

            model.goToNextMonth = () => {
                model.date(moment(model.date()).add(1, 'M'));
            }

            model.getDayTotal = function(day, role) {
                return model.daysMatrix[day][role].total;
            }

            model.getDayAssigned = function(day, role) {
                return model.daysMatrix[day][role].assigned;
            }

            model.percentageColorClass = function(day, role) {
                let value = model.daysMatrix[day][role].prctAssignedColor;

                if (value.toUpperCase() === 'RED') {
                    return 'number-red';
                } else if (value.toUpperCase() === 'GREEN') {
                    return 'number-green';
                } else if (value.toUpperCase() === 'YELLOW') {
                    return 'number-yellow';
                } else if (value.toUpperCase() === 'ORANGE') {
                    return 'number-orange';
                }
            }

            model.dayColorClass = function(color) {
                let value = color ? color.toUpperCase() : '';

                if (value === 'RED') {
                    return 'day-red';
                } else if (value === 'GREEN') {
                    return 'day-green';
                } else if (value === 'YELLOW') {
                    return 'day-yellow';
                } else if (value === 'ORANGE') {
                    return 'day-orange';
                }
            }

            model.performScroll = ko.observable(false);


            //model.legendVisible = ko.observable(false);
            //model.legendTop = ko.observable(20);
            //model.legendLeft = ko.observable(50);
            //model.showLegend = function (data, event) {
            //    //model.legendTop(event.clientY + 'px');
            //    //model.legendLeft(event.clientX + 'px');

            //    model.legendVisible(true);
            //}
            //model.hideLegend = function () {
            //    model.legendVisible(false);
            //}

            //
            // Modal Day Manpower Details
            //
            model.dayManpowerDetailsModalInit = function(vm) {
                vm.dayManpowerDetailsModal = {};
                self = vm.dayManpowerDetailsModal;

                self.dialogDisplaying = ko.observable(false);
                self.date = ko.observable(null);
                self.roleInfoLines = ko.observableArray([]);
                self.manpowerHoursTotal = ko.observable(0.0);

                self.showDialog = function(date) {
                    self.date(date);
                    let dayValues = [];
                    vm.roleHeaders.forEach(roleHeaderName => dayValues.push(vm.daysMatrix[date][roleHeaderName]));
                    self.roleInfoLines(dayValues);
                    self.manpowerHoursTotal(vm.weeks[vm.daysMatrix[date][vm.roleHeaders[0]].weekNbr - 1].totalHoursForWeek);
                    self.dialogDisplaying(true);
                };

                self.hideDialog = function() {
                    self.dialogDisplaying(false);
                };

            }

            model.dayManpowerDetailsModalInit(model);
            //
            //





            //
            // Setup binding handlers
            //
            ko.bindingHandlers.datepicker = ServiceTRAXBindingHandlers.datepicker;
            ko.bindingHandlers.koScrollTo = ServiceTRAXBindingHandlers.koScrollTo;
            ko.bindingHandlers.selectPicker = ServiceTRAXBindingHandlers.selectPicker;
            ko.bindingHandlers.showModal = ServiceTRAXBindingHandlers.showModal;
            //
            //

            //
            // KO ApplyBindings
            ko.applyBindings(model);
            //
            //


            setTimeout(function() { model.performScroll(true); }, 700);
        });

    </script>

}


    <script type="text/html" id="occupacy-color-legend">
                                                        <div id="color-legend-table" class="border border-dark p-2 text-center legend-box">
                                                            <table class="table table-borderless mb-2">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width:80px">From</th>
                                                                        <th style="width:10px"></th>
                                                                        <th style="width:80px"></th>
                                                                        <th style="width:10px"></th>
                                                                        <th style="width:80px">To</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody class="text-black">
                    @if (Model.OccupancyColorRanges.ScheduleMonthlyGreenFrom != Model.OccupancyColorRanges.ScheduleMonthlyGreenTo)
                {
                                                                        <tr>
                                                                            <td>@(Model.OccupancyColorRanges.ScheduleMonthlyGreenFrom < 0 ? 0 : Model.OccupancyColorRanges.ScheduleMonthlyGreenFrom)</td>
                                                                            <th style="width:10px">&ge;</th>
                                                                            <td class="day-green">Green</td>
                                                                            <th style="width:10px">&lt;</th>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyGreenTo</td>
                                                                        </tr>
                }
                @if (Model.OccupancyColorRanges.ScheduleMonthlyYellowFrom != Model.OccupancyColorRanges.ScheduleMonthlyYellowTo)
                {
                                                                        <tr>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyYellowFrom</td>
                                                                            <th style="width:10px">&ge;</th>
                                                                            <td class="day-yellow">Yellow</td>
                                                                            <th style="width:10px">&lt;</th>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyYellowTo</td>
                                                                        </tr>
                }
                @if (Model.OccupancyColorRanges.ScheduleMonthlyOrangeFrom != Model.OccupancyColorRanges.ScheduleMonthlyOrangeTo)
                {
                                                                        <tr>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyOrangeFrom</td>
                                                                            <th style="width:10px">&ge;</th>
                                                                            <td class="day-orange">Orange</td>
                                                                            <th style="width:10px">&lt;</th>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyOrangeTo</td>
                                                                        </tr>
                }
                @if (Model.OccupancyColorRanges.ScheduleMonthlyRedFrom != Model.OccupancyColorRanges.ScheduleMonthlyRedTo)
                {
                                                                        <tr>
                                                                            <td>@Model.OccupancyColorRanges.ScheduleMonthlyRedFrom</td>
                                                                            <th style="width:10px">&ge;</th>
                                                                            <td class="day-red">Red</td>
                                                                            <th style="width:10px">&le;</th>
                                                                            <td>@(Model.OccupancyColorRanges.ScheduleMonthlyRedTo > 100 ? 100 : Model.OccupancyColorRanges.ScheduleMonthlyRedTo)</td>
                                                                        </tr>
                }
            </tbody>
        </table>
    </div>
</script>



<script type="text/html" id="occupacy-color-legend-plain">
    <a id="color-range-legends-section">
        <div id="color-legend-table" class="border border-dark p-2 text-center legend-box">
            <table class="table table-borderless mb-2 mx-2">
                <thead>
                    <tr>
                        <th style="width:85px"></th>
                        <th style="width:220px"></th>
                    </tr>
                </thead>
                <tbody class="text-black">
                    <tr>
                        <td class="pb-3" colspan="2"><strong>Capacity Value Range Colors</strong></td>
                    </tr>
                    @if (Model.OccupancyColorRanges.ScheduleMonthlyGreenFrom != Model.OccupancyColorRanges.ScheduleMonthlyGreenTo)
                    {
                                                                            <tr>
                                                                                <td class="day-green">Green</td>
                                                                                <td class="text-left">@(Model.OccupancyColorRanges.ScheduleMonthlyGreenTo)% or less</td>
                                                                            </tr>
                    }
                    @if (Model.OccupancyColorRanges.ScheduleMonthlyYellowFrom != Model.OccupancyColorRanges.ScheduleMonthlyYellowTo)
                    {
                                                                            <tr>
                                                                                <td class="day-yellow">Yellow</td>
                                                                                <td class="text-left">@(Model.OccupancyColorRanges.ScheduleMonthlyYellowFrom)% - @(Model.OccupancyColorRanges.ScheduleMonthlyYellowTo)%</td>
                                                                            </tr>
                    }
                    @if (Model.OccupancyColorRanges.ScheduleMonthlyOrangeFrom != Model.OccupancyColorRanges.ScheduleMonthlyOrangeTo)
                    {
                                                                            <tr>
                                                                                <td class="day-orange">Orange</td>
                                                                                <td class="text-left">@(Model.OccupancyColorRanges.ScheduleMonthlyOrangeFrom)% - @(Model.OccupancyColorRanges.ScheduleMonthlyOrangeTo)%</td>
                                                                            </tr>
                    }
                    @if (Model.OccupancyColorRanges.ScheduleMonthlyRedFrom != Model.OccupancyColorRanges.ScheduleMonthlyRedTo)
                    {
                                                                            <tr>
                                                                                <td class="day-red">Red</td>
                                                                                <td class="text-left">@(Model.OccupancyColorRanges.ScheduleMonthlyRedFrom)% or more</td>
                                                                            </tr>
                    }
                </tbody>
            </table>
        </div>
    </a></script>

<script type="text/html" id="total-card">
    <td class="text-right pl-0">
        <div class="card total-card bg-dark-blue p-3 text-center">
            <span class="week-num mb-2">Week <span data-bind="text:weekNbr"></span> Manpower Hours</span>
            <span class="week-total" data-bind="text:totalHoursForWeek.toFixed(1)"></span>
        </div>
    </td>
</script>


<script type="text/html" id="day-card-header">
    <td class="text-center">
        <!-- ko if:moment(date).isSame(moment(), 'day')-->
        <span data-bind="koScrollTo:$root.performScroll"></span>
        <!-- /ko -->
        <a data-bind="attr: {href: $root.redirectToDay(date)}">
        <div class="card date-card previous-month p-2 text-center position-relative" data-bind="css: { 'highlight-curr-day': moment(date).isSame(moment(), 'day') }">
            <span class="date d-block p-0" data-bind="text:moment(date).format('D')"></span>
            <span class="month d-block p-0 ucase" data-bind="text:moment(date).format('MMM')">Mar</span>
            <span class="day d-block pt-3 ucase" data-bind="text:moment(date).format('ddd')"></span>
            <div class="health position-absolute" data-bind="class:$root.dayColorClass(color)"></div>
        </div>
        </a>
    </td>
</script>


<script type="text/html" id="week-values-rows">
    <tr>
        <td class="text-right">
            <div class="scheduler-labels text-uppercase" data-bind="text:rolename"></div>
        </td>
        <!-- ko foreach:localDayHeaders -->
        <td class="text-center">
            <div class="fraction">
                <span class="text-green mr-1" data-bind="class:$root.percentageColorClass(date, $parent.rolename), text:$root.getDayAssigned(date, $parent.rolename)"></span>/<span class="text-green ml-1" data-bind="class:$root.percentageColorClass(date, $parent.rolename), text:$root.getDayTotal(date, $parent.rolename)"></span>
            </div>
        </td>
        <!-- /ko -->
    </tr>
</script>


<script type="text/html" id="mobile-week-values-rows">
    <td class="day">
        <div class="day-contents position-relative" data-bind="click:() => $root.dayManpowerDetailsModal.showDialog(date)">
            <div class="d-block pt-2 day-label" data-bind="text:moment(date).format('D')"></div>
            <div class="d-block pb-3 month-label" data-bind="text:moment(date).format('MMM')"></div>
            <div class="position-absolute status" data-bind="class:$root.dayColorClass(color)"></div>
        </div>
    </td>
</script>


<script type="text/html" id="full-week-row">
    <div class="row align-items-end">
        <div class="col">
            <table class="table scheduler-month-table mb-2">
                <tbody>
                    <tr>
                        <!-- ko if:$root.userCanSeeDetails -->
                        <!-- ko template: { name:'total-card', data: totals } --><!-- /ko -->
                        <!-- /ko -->
                        <!-- ko foreach:localDayHeaders -->
                        <!-- ko template: { name:'day-card-header' } --><!-- /ko -->
                        <!-- /ko -->
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col">
            <table class="table table--white scheduler-month-table mb-0">
                <tbody>
                    <!-- ko foreach:$root.roleHeaders -->
                    <!-- ko template: { name:'week-values-rows', data: { rolename: $data, localDayHeaders: $parent.localDayHeaders } } --><!-- /ko -->
                    <!-- /ko -->
                </tbody>
            </table>

        </div>
    </div>
</script>


<div id="content" class="position-relative">
    <div class="bg-blue p-2 d-flex align-items-center">
        <div class="d-flex align-items-center">
            <button class="btn icon-only" data-bind="click:goToPrevMonth" title="Move to Previous Month"><em class="fas fa-chevron-left"></em></button>

            <div class="input-group" id="triggerCalendar">
                <input type="text"
                       autocomplete="off"
                       class="form-control"
                       id="month"
                       data-bind="datepicker: date, datepickerOptions: { trigger: '#triggerCalendar', format: 'mm/yyyy' }"
                       required />
                <div class="input-group-append simulate-button">
                    <span class="input-group-text input-group-append-custom">
                        <i class="fas fa-calendar"></i>
                    </span>
                </div>
            </div>
            <button class="btn icon-only" data-bind="click:goToNextMonth" title="Move to Next Month"><em class="fas fa-chevron-right"></em></button>
        </div>
        <a class=" d-none d-lg-block ml-auto text-white" href="#color-range-legends-section"><i class="far fa-question-circle"></i> Color Range Values</a>

        <!-- ko if: organizationLocations.length > 2 -->
        <div class="ml-auto d-flex align-items-center">
            <span class="pr-2 d-none d-lg-block">Organization Location</span>
            <select data-style="btn-white shadow-sm"
                    data-width="auto"
                    data-bind="selectPicker:true, options: organizationLocations, optionsText: 'locationName', optionsValue: 'locationID', value: resourceLocationId, valueAllowUnset: true">
            </select>
        </div>
        <!-- /ko -->
    </div>




    <div class="container-fluid  d-none d-lg-block">
        <!-- ko foreach:weeks -->
        <!-- ko template: { name:'full-week-row', data:{ localDayHeaders: weekDays, totals: { weekNbr:weekNbr, totalHoursForWeek:totalHoursForWeek } } } --><!-- /ko -->
        <!-- /ko -->

        <div class="row text-center pl-3 mt-5" style="zoom:.8">
            <!-- ko template: { name:'occupacy-color-legend-plain' } --><!-- /ko -->
        </div>
    </div>

    <div class="container d-lg-none">
        <section id="monthly_mobile">
            <div class="row">
                <div class="col-12">
                    <div class="calendar">
                        <table class="calendar-table" border="0" cellspacing="0" cellpadding="0">
                            <thead>
                                <tr class="header-days">
                                    <td class="header-day">Sun</td>
                                    <td class="header-day">Mon</td>
                                    <td class="header-day">Tue</td>
                                    <td class="header-day">Wed</td>
                                    <td class="header-day">Thu</td>
                                    <td class="header-day">Fri</td>
                                    <td class="header-day">Sat</td>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ko foreach:weeks -->
                                <tr>
                                    <!-- ko foreach:weekDays -->
                                    <!-- ko template: { name:'mobile-week-values-rows' } --><!-- /ko -->
                                    <!-- /ko -->
                                </tr>
                                <!-- /ko -->
                            </tbody>
                        </table>

                        <div id="week-totals" class="mt-3">
                            <div class="week-totals-title">Weekly Manpower Hours</div>
                            <ul class="list-unstyled">
                                <!-- ko foreach:weeks -->
                                <li>Week <span data-bind="text:weekNbr"></span>: <strong data-bind="text:totalHoursForWeek.toFixed(1)"></strong></li>
                                <!-- /ko -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="row text-center" style="zoom:.8">
            <!-- ko template: { name:'occupacy-color-legend-plain' } --><!-- /ko -->
        </div>
    </div>
</div>

<!-- ko with:dayManpowerDetailsModal -->
<div class="modal" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true" data-backdrop="static" data-bind="showModal:dialogDisplaying">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header align-items-center">
                <div class="modal-title d-inline-block" id="calendarModalLabel"><span data-bind="text:moment(date()).format('MMMM D')"></span><button class="btn btn-primary btn-sm btn-icon ml-2"><em class="fas fa-angle-right"></em></button></div>

                <button type="button" class="d-inline-block btn btn-sm btn-icon-only close mr-0" aria-label="Close" data-bind="click:$root.dayManpowerDetailsModal.hideDialog">
                    <span aria-hidden="true"><em class="fas fa-times"></em></span>
                </button>
                <div class="d-block m-0 p-0">Week's Manpower Hours:  <strong data-bind="text:manpowerHoursTotal().toFixed(1)"></strong></div>

            </div>
            <div class="modal-body">
                <ul class="totals list-unstyled" data-bind="foreach:roleInfoLines">
                    <li>
                        <div class="inline-block description"><strong data-bind="text:roleName"></strong></div>
                        <div class="inline-block total"><strong data-bind="text:assigned"></strong>/<strong data-bind="text:total"></strong></div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- /ko -->
