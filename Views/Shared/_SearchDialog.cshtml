<div id="draggableSearchDialog" style="display:none; width: 300px">
    <div class="card">
        <div id="draggableSearchDialogTitle" class="card-header d-flex align-items-center pr-0">
            <h4 class="p-0 m-0 flex-fill">
                <em class="fas fa-search mr-2 turquoise-icon"></em><span class="text-white">Search</span>
            </h4>
            <button type="button" class="btn icon-only" onclick="showSearchDialog()">
                <em class="fas fa-times"></em>
            </button>
        </div>
        <div class="card-body p-3">
            <div id="search-wrapper">
                <div class="align-items-center">
                    <div class="form-group">
                        <input id="dsd-proj-number" type="text" placeholder="Search Project Number..." class="form-control w-100 searchOnEnter" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <input id="dsd-proj-name" type="text" placeholder="Search Project Name..." class="form-control w-100 searchOnEnter" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <select id="customerPicker"
                                class="col-12 px-0"
                                data-style="btn-white shadow-sm"
                                data-live-search="true"
                                data-none-selected-text="Search by Customer Name...">
                        </select>
                    </div>

                    <div class="form-group">
                        <select id="endUserPicker"
                                class="col-12 px-0"
                                data-style="btn-white shadow-sm"
                                data-live-search="true"
                                data-size="10"
                                data-none-selected-text="Search by End User Name...">
                        </select>
                    </div>

                    <div class="form-group">
                        <input id="dsd-invoice-number" type="text" placeholder="Search Invoice Number..." class="form-control w-100 searchOnEnter" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <input id="dsd-po-number" type="text" placeholder="Search PO Number..." class="form-control w-100 searchOnEnter" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <input id="dsd-hbquote-number" type="text" placeholder="Search HB Quote Number..." class="form-control w-100 searchOnEnter" autocomplete="off">
                    </div>

                    <div class="form-row mt-2">
                        <div class="col-6">
                            <button class="btn btn-primary col-12" onclick="searchAction()">
                                <i class="fas fa-search"></i> <span>Search</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-green col-12" onclick="clearSearchValues()">
                                <span>Clear</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

        var draggableSearchDialog = {
            usersLoaded: false,
            customersLoaded: false,
            isDisplaying: false,
            firstDisplay: true
        }

        $(document).ready(function () {
            draggableSearchWindow();
        });

        clearSearchValues = function() {
            $('#dsd-proj-number').val('');
            $('#dsd-proj-name').val('');
            $('#dsd-invoice-number').val('');
            $('#dsd-po-number').val('');
            $('#dsd-hbquote-number').val('');
            $("#endUserPicker").val('default').selectpicker("refresh");
            $("#customerPicker").val('default').selectpicker("refresh");
        }

        $('.searchOnEnter').keypress(function (e) {
             var key = e.which;
             if(key == 13)  // the enter key code
              {
                searchAction();
                return false;
              }
        });

        searchAction = function()  {
            const searchParameters = {
                OrganizationID: @Model.OrganizationID,
                ProjectNumber: $('#dsd-proj-number').val(),
                ProjectName: $('#dsd-proj-name').val(),
                InvoiceNumber: $('#dsd-invoice-number').val(),
                PONumber: $('#dsd-po-number').val(),
                HBQuote: $('#dsd-hbquote-number').val(),
                EndUser: $('#endUserPicker').selectpicker('val'),
                Customer: $('#customerPicker').selectpicker('val')
            };
            redirectToPage('/search/index', searchParameters);
        }

        createSelectOptions = function(values, selectId, idProp, valueProp) {
            // Create the options (as text because is fastest)
            let options = '';
            values.forEach(eu => options += `<option value="${eu[idProp]}">${eu[valueProp]}</option>`)
            // Set the inner html of the Select component
            document.getElementById(selectId).innerHTML = '<option></option>' +  options;
            // Refresh the Bootstrap Select component
            $(`#${selectId}`).selectpicker('refresh');
        }

        showSearchDialog = function() {

            if(!draggableSearchDialog.usersLoaded) {
                // Request customer and End Users list
                getWrapper('/api/v1/endusers', {'OrganizationID': @Model.OrganizationID})
                    .then(({value}) => { createSelectOptions(value, 'endUserPicker', 'end_user_name', 'end_user_name'); draggableSearchDialog.usersLoaded = true; });
            }

            if(!draggableSearchDialog.customersLoaded) {
                getWrapper('/api/v1/customers', {'OrganizationID': @Model.OrganizationID})
                    .then(({value}) => { createSelectOptions(value, 'customerPicker', 'customer_Name', 'customer_Name'); draggableSearchDialog.customersLoaded = true; });
            }

            const searchButton = document.getElementById("searchToggleButton");
            const buttonPos = searchButton.getBoundingClientRect();
            const dialog = document.getElementById("draggableSearchDialog");

            if(!draggableSearchDialog.isDisplaying) {
                dialog.style.display = "block";
                //$('#dsd-proj-number').focus(); // this causes the page to jump to the bottom, using {preventScroll: true} did not worked either

                if(draggableSearchDialog.firstDisplay) {
                    dialog.style.position = "fixed";
                    dialog.style.left = `${buttonPos.left - dialog.offsetWidth + 20}px`;
                    dialog.style.top = `${buttonPos.top + buttonPos.height + 2}px`;
                    console.log('DD', dialog.style.right, buttonPos, dialog.offsetWidth);
                    draggableSearchDialog.firstDisplay = false;
                }
            } else {
                dialog.style.display = "none";
            }
            draggableSearchDialog.isDisplaying = !draggableSearchDialog.isDisplaying;
        }

            draggableSearchWindow = function() {
                  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                  var elmnt = document.getElementById("draggableSearchDialog");
                  document.getElementById("draggableSearchDialog").onmousedown = dragMouseDown;

                  function dragMouseDown(e) {
                        e = e || window.event;
                        //e.preventDefault();
                        // get the mouse cursor position at startup:
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        // call a function whenever the cursor moves:
                        document.onmousemove = elementDrag;
                    }

                    function elementDrag(e) {
                        e = e || window.event;
                        e.preventDefault();
                        // calculate the new cursor position:
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        // set the element's new position:
                        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                    }

                    function closeDragElement() {
                        // stop moving when mouse button is released:
                        document.onmouseup = null;
                        document.onmousemove = null;
                    }
            }
</script>